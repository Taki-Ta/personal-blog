---
title: Docker ç½‘ç»œç»“æ„å®Œæ•´è¯´æ˜
date: 2025-12-29 10:35:00
categories:
  - æŠ€æœ¯æ–‡æ¡£
tags:
  - Docker
---
## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)

1. [ç½‘ç»œæ¶æ„](#ç½‘ç»œæ¶æ„)

1. [å®¹å™¨ç½‘ç»œé€šä¿¡](#å®¹å™¨ç½‘ç»œé€šä¿¡)

1. [å®æˆ˜ç¤ºä¾‹](#å®æˆ˜ç¤ºä¾‹)

1. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

1. [è¯Šæ–­å‘½ä»¤](#è¯Šæ–­å‘½ä»¤)

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. Dockerç½‘ç»œçš„ä¸‰å¤§ç»„ä»¶

### â‘  è™šæ‹Ÿç½‘å¡å¯¹ (veth pair)

**æ¦‚å¿µï¼š** ä¸€å¯¹è™šæ‹Ÿç½‘å¡ï¼Œåƒä¸€æ ¹è™šæ‹Ÿç½‘çº¿è¿æ¥å®¹å™¨å’Œå®¿ä¸»æœº

```javascript
å®¹å™¨å†…éƒ¨          |          å®¿ä¸»æœº
                  |
  eth0 â†â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â†’ vethxxxxxx
  172.18.0.5      |          (è¿æ¥åˆ°ç½‘æ¡¥)
```

**ç‰¹ç‚¹ï¼š**

- ä¸€ç«¯åœ¨å®¹å™¨å†…(é€šå¸¸å« `eth0`)

- å¦ä¸€ç«¯åœ¨å®¿ä¸»æœº(åå­—ç±»ä¼¼ `veth1a2b3c4`)

- æ•°æ®ä»ä¸€ç«¯è¿›,ä»å¦ä¸€ç«¯å‡º

**æŸ¥çœ‹å‘½ä»¤ï¼š**

```bash
# åœ¨å®¿ä¸»æœºæŸ¥çœ‹
ip link show | grep veth

# åœ¨å®¹å™¨å†…æŸ¥çœ‹
docker exec å®¹å™¨å ip addr show eth0
```

---

### â‘¡ ç½‘æ¡¥ (Bridge)

**æ¦‚å¿µï¼š** è™šæ‹Ÿçš„ç½‘ç»œäº¤æ¢æœºï¼Œè¿æ¥å¤šä¸ªå®¹å™¨

```javascript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç½‘æ¡¥ (br-abc123) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                         â”‚
â”‚    veth1234 â†â†’ veth5678 â†â†’ veth9abc   â”‚
â”‚      â”‚           â”‚           â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚           â”‚           â”‚
    [å®¹å™¨A]     [å®¹å™¨B]     [å®¹å™¨C]
```

**ä½œç”¨ï¼š**

- è½¬å‘æ•°æ®åŒ…(ç±»ä¼¼ç‰©ç†äº¤æ¢æœº)

- ç»´æŠ¤MACåœ°å€è¡¨

- éš”ç¦»ä¸åŒç½‘ç»œçš„å®¹å™¨

**æŸ¥çœ‹å‘½ä»¤ï¼š**

```bash
# æŸ¥çœ‹æ‰€æœ‰ç½‘æ¡¥
brctl show

# æˆ–ä½¿ç”¨Dockerå‘½ä»¤
docker network ls
```

---

### â‘¢ ç½‘ç»œå‘½åç©ºé—´ (Network Namespace)

**æ¦‚å¿µï¼š** æ¯ä¸ªå®¹å™¨æœ‰ç‹¬ç«‹çš„ç½‘ç»œæ ˆ

```javascript
å®¹å™¨Aå‘½åç©ºé—´        å®¹å™¨Bå‘½åç©ºé—´
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 127.0.0.1  â”‚      â”‚ 127.0.0.1  â”‚  â† å„è‡ªç‹¬ç«‹
â”‚ eth0       â”‚      â”‚ eth0       â”‚
â”‚ è·¯ç”±è¡¨     â”‚      â”‚ è·¯ç”±è¡¨     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**éš”ç¦»å†…å®¹ï¼š**

- IPåœ°å€

- è·¯ç”±è¡¨

- é˜²ç«å¢™è§„åˆ™

- ç½‘ç»œæ¥å£

---

## ç½‘ç»œæ¶æ„

### Dockerç½‘ç»œç±»å‹

### 1. bridge(é»˜è®¤ç½‘ç»œ)

```bash
docker network ls
# NETWORK ID       NAME      DRIVER
# abc123          bridge    bridge    â† Dockerè‡ªå¸¦çš„é»˜è®¤ç½‘ç»œ
```

**ç‰¹ç‚¹ï¼š**

- æ‰€æœ‰ `docker run` åˆ›å»ºçš„å®¹å™¨é»˜è®¤åŠ å…¥

- ç½‘æ¡¥åç§°ï¼š`docker0`

- ç½‘æ®µï¼šé€šå¸¸ `172.17.0.0/16`

- å®¹å™¨é—´å¯ä»¥é€šè¿‡IPäº’è®¿ï¼Œä½†**ä¸èƒ½ç”¨å®¹å™¨å**

---

### 2. è‡ªå®šä¹‰ç½‘ç»œ(æ¨è)

```bash
# æ‰‹åŠ¨åˆ›å»º
docker network create my_network

# docker-composeè‡ªåŠ¨åˆ›å»º
docker-compose up  # è‡ªåŠ¨åˆ›å»º é¡¹ç›®å_default ç½‘ç»œ
```

**ç‰¹ç‚¹ï¼š**

- ç½‘æ¡¥åç§°ï¼š`br-xxxxxxxx`(éšæœºID)

- å¯ä»¥è‡ªå®šä¹‰ç½‘æ®µ

- å®¹å™¨é—´**å¯ä»¥ç”¨å®¹å™¨å**äº’è®¿(å†…ç½®DNS)

- æ›´å¥½çš„éš”ç¦»æ€§

---

### å®Œæ•´ç½‘ç»œæ¶æ„å›¾

```javascript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å®¿ä¸»æœº                                   â”‚
â”‚                                                                   â”‚
â”‚  ç‰©ç†ç½‘å¡: ens20 (192.169.1.121)                                 â”‚
â”‚       â”‚                                                           â”‚
â”‚       â”‚ (å¤–éƒ¨æµé‡)                                                â”‚
â”‚       â†“                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚         iptables / NAT è§„åˆ™                         â”‚         â”‚
â”‚  â”‚  ç«¯å£æ˜ å°„: -p 5001:5001 â†’ 172.18.0.8:5001         â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                   â†“                                               â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—          â”‚
â”‚  â•‘            docker0 ç½‘æ¡¥ (é»˜è®¤bridge)              â•‘          â”‚
â”‚  â•‘           172.17.0.0/16                            â•‘          â”‚
â”‚  â•‘                                                    â•‘          â”‚
â”‚  â•‘    veth001f34c â†â†’ [GWAgentå®¹å™¨]                  â•‘          â”‚
â”‚  â•‘       â†‘              172.17.0.2                    â•‘          â”‚
â”‚  â•‘    å®¿ä¸»æœºä¾§       å®¹å™¨å†… eth0                     â•‘          â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•          â”‚
â”‚                                                                   â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—          â”‚
â”‚  â•‘         br-43ebdd777e58 (docker_default)          â•‘          â”‚
â”‚  â•‘           172.18.0.0/16                            â•‘          â”‚
â”‚  â•‘                                                    â•‘          â”‚
â”‚  â•‘    veth510a281 â†â†’ [Dify-API]    172.18.0.8       â•‘          â”‚
â”‚  â•‘    veth0d9257b â†â†’ [Dify-DB]     172.18.0.9       â•‘          â”‚
â”‚  â•‘    vethae6b5f8 â†â†’ [Dify-Redis]  172.18.0.10      â•‘          â”‚
â”‚  â•‘    ... (æ›´å¤šå®¹å™¨)                                 â•‘          â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•          â”‚
â”‚                                                                   â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—          â”‚
â”‚  â•‘      br-2d6e1e6b461e (ssrf_proxy_network)         â•‘          â”‚
â”‚  â•‘           172.19.0.0/16                            â•‘          â”‚
â”‚  â•‘                                                    â•‘          â”‚
â”‚  â•‘    veth236b89c â†â†’ [Proxyå®¹å™¨]                    â•‘          â”‚
â”‚  â•‘    vethf1c8fce â†â†’ [Dify-APIçš„eth1] â† å¤šç½‘å¡!    â•‘          â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®¹å™¨ç½‘ç»œé€šä¿¡

### åœºæ™¯1ï¼šåŒä¸€ç½‘ç»œå†…çš„å®¹å™¨é€šä¿¡(æ¨è)

```javascript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ docker_default ç½‘ç»œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                            â”‚
â”‚  [GWAgent] 172.18.0.5                     â”‚
â”‚      â”‚                                     â”‚
â”‚      â”‚ curl [http://dify-api:5001](http://dify-api:5001/)          â”‚
â”‚      â†“                                     â”‚
â”‚      é€šè¿‡ç½‘æ¡¥è½¬å‘                          â”‚
â”‚      â†“                                     â”‚
â”‚  [Dify-API] 172.18.0.8:5001              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æµé‡è·¯å¾„ï¼š**

```javascript
GWAgentå®¹å™¨ (eth0: 172.18.0.5)
    â†“
  æ•°æ®åŒ…å‘é€åˆ°ç½‘æ¡¥
    â†“
  ç½‘æ¡¥æŸ¥MACåœ°å€è¡¨
    â†“
  è½¬å‘åˆ°ç›®æ ‡å®¹å™¨çš„veth
    â†“
Difyå®¹å™¨ (eth0: 172.18.0.8)
```

**è®¿é—®æ–¹å¼ï¼š**

```bash
# âœ… æ¨èï¼šä½¿ç”¨å®¹å™¨å(è‡ªåŠ¨DNSè§£æ)
curl [http://dify-api:5001/v1/workflows/run](http://dify-api:5001/v1/workflows/run)

# âœ… ä¹Ÿå¯ä»¥ï¼šä½¿ç”¨å®¹å™¨IP
curl [http://172.18.0.8:5001/v1/workflows/run](http://172.18.0.8:5001/v1/workflows/run)

# âŒ é”™è¯¯ï¼šä½¿ç”¨[localhost](http://localhost/)
curl [http://localhost:5001](http://localhost:5001/)  # åªä¼šè®¿é—®è‡ªå·±ï¼
```

**ç‰¹ç‚¹ï¼š**

- âš¡ é€Ÿåº¦æœ€å¿«(~1-2mså»¶è¿Ÿ)

- ğŸ”’ å†…éƒ¨éš”ç¦»,å¤–éƒ¨æ— æ³•ç›´æ¥è®¿é—®

- ğŸš« ä¸ç»è¿‡å®¿ä¸»æœºç½‘ç»œåè®®æ ˆ

- ğŸš« ä¸ç»è¿‡NATè½¬æ¢

---

### åœºæ™¯2ï¼šè·¨ç½‘ç»œå®¹å™¨é€šä¿¡(éœ€è¦æ‰‹åŠ¨è¿æ¥)

```javascript
â”Œâ”€â”€â”€ bridgeç½‘ç»œ â”€â”€â”€â”         â”Œâ”€â”€â”€ docker_default â”€â”€â”€â”
â”‚                   â”‚         â”‚                       â”‚
â”‚  [GWAgent]        â”‚ âœ— ä¸é€š â”‚  [Dify-API]          â”‚
â”‚  172.17.0.2       â”‚ â†â”€â”€â”€â”€â”€â†’ â”‚  172.18.0.8          â”‚
â”‚                   â”‚         â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è§£å†³æ–¹æ¡ˆï¼šæŠŠå®¹å™¨åŠ å…¥ç›®æ ‡ç½‘ç»œ**

```bash
# æŸ¥çœ‹Difyæ‰€åœ¨çš„ç½‘ç»œ
docker inspect dify-api | grep -A 10 Networks

# å‡è®¾è¾“å‡ºæ˜¾ç¤ºåœ¨ docker_default ç½‘ç»œ
docker network connect docker_default gwagent

# ç°åœ¨GWAgentæœ‰ä¸¤ä¸ªç½‘å¡äº†
docker exec gwagent ip addr
# eth0: 172.17.0.2 (bridgeç½‘ç»œ)
# eth1: 172.18.0.5 (docker_defaultç½‘ç»œ) â† æ–°å¢
```

**è¿æ¥åçš„æ¶æ„ï¼š**

```javascript
â”Œâ”€â”€â”€ bridgeç½‘ç»œ â”€â”€â”€â”         â”Œâ”€â”€â”€ docker_default â”€â”€â”€â”
â”‚                   â”‚         â”‚                       â”‚
â”‚  [GWAgent]        â”‚         â”‚  [GWAgent]  â† åŒä¸€å®¹å™¨
â”‚  eth0: 172.17.0.2 â”‚         â”‚  eth1: 172.18.0.5    â”‚
â”‚                   â”‚         â”‚       â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚       â†“ å¯ä»¥è®¿é—®     â”‚
                              â”‚  [Dify-API]          â”‚
                              â”‚  172.18.0.8          â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### åœºæ™¯3ï¼šå®¿ä¸»æœºè®¿é—®å®¹å™¨

### æ–¹å¼Aï¼šç›´æ¥è®¿é—®å®¹å™¨IP

```bash
# åœ¨å®¿ä¸»æœºä¸Š
curl [http://172.18.0.8:5001](http://172.18.0.8:5001/)
```

**æµé‡è·¯å¾„ï¼š**

```javascript
å®¿ä¸»æœº
  â†“
  è·¯ç”±è¡¨åˆ¤æ–­: 172.18.0.8 åœ¨ br-43ebdd777e58
  â†“
  å‘é€åˆ°ç½‘æ¡¥
  â†“
  ç½‘æ¡¥è½¬å‘åˆ°ç›®æ ‡veth
  â†“
å®¹å™¨
```

**ç‰¹ç‚¹ï¼š**

- âœ… ç®€å•ç›´æ¥

- âš ï¸ å®¹å™¨é‡å¯åIPå¯èƒ½å˜åŒ–

- ğŸ”’ åªèƒ½åœ¨å®¿ä¸»æœºæœ¬åœ°è®¿é—®

---

### æ–¹å¼Bï¼šé€šè¿‡ç«¯å£æ˜ å°„(å¯¹å¤–æš´éœ²)

```bash
docker run -p 5001:5001 dify-api
```

**æµé‡è·¯å¾„ï¼š**

```javascript
å¤–éƒ¨å®¢æˆ·ç«¯ (192.169.1.100)
  â†“
  è®¿é—®: [http://192.169.1.121:5001](http://192.169.1.121:5001/)
  â†“
å®¿ä¸»æœºç‰©ç†ç½‘å¡ (ens20)
  â†“
iptables NATè§„åˆ™: 5001 â†’ 172.18.0.8:5001
  â†“
ç½‘æ¡¥è½¬å‘
  â†“
å®¹å™¨ (172.18.0.8:5001)
```

**ç‰¹ç‚¹ï¼š**

- ğŸŒ å¤–éƒ¨å¯è®¿é—®

- ğŸŒ ç»è¿‡NAT,ç¨æ…¢(~5-10ms)

- ğŸ”“ éœ€è¦è€ƒè™‘å®‰å…¨æ€§

---

### åœºæ™¯4ï¼šå®¹å™¨è®¿é—®å¤–éƒ¨ç½‘ç»œ

```javascript
å®¹å™¨ (172.18.0.8)
  â†“
  è¯·æ±‚: [http://www.baidu.com](http://www.baidu.com/)
  â†“
ç½‘æ¡¥çš„é»˜è®¤ç½‘å…³ (172.18.0.1)
  â†“
iptables NAT (æºåœ°å€è½¬æ¢)
  172.18.0.8 â†’ 192.169.1.121
  â†“
å®¿ä¸»æœºç‰©ç†ç½‘å¡ (ens20)
  â†“
å¤–éƒ¨äº’è”ç½‘
```

**å…³é”®é…ç½®ï¼š**

```bash
# æŸ¥çœ‹NATè§„åˆ™
iptables -t nat -L -n

# è¾“å‡ºä¼šåŒ…å«ç±»ä¼¼è§„åˆ™ï¼š
# MASQUERADE  all  --  172.18.0.0/16  0.0.0.0/0
```

---

## å®æˆ˜ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šå°†GWAgentåŠ å…¥Difyç½‘ç»œ

```bash
# 1. æŸ¥çœ‹Difyå®¹å™¨çš„ç½‘ç»œ
docker inspect dify-api | grep -A 10 '"Networks"'

# è¾“å‡ºç¤ºä¾‹ï¼š
# "Networks": {
#     "docker_default": {
#         "IPAddress": "172.18.0.8",
#         ...
#     }
# }

# 2. å°†GWAgentåŠ å…¥åŒä¸€ç½‘ç»œ
docker network connect docker_default gwagent

# 3. éªŒè¯ç½‘ç»œè¿æ¥
docker exec gwagent ip addr
# åº”è¯¥çœ‹åˆ°ä¸¤ä¸ªç½‘å¡ï¼šeth0 å’Œ eth1

# 4. æµ‹è¯•è¿é€šæ€§
docker exec gwagent curl [http://dify-api:5001/v1/health](http://dify-api:5001/v1/health)
```

---

### ç¤ºä¾‹2ï¼šåˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œå¹¶è¿è¡Œå®¹å™¨

```bash
# 1. åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ
docker network create \
  --driver bridge \
  --subnet 172.20.0.0/16 \
  --gateway 172.20.0.1 \
  my_custom_network

# 2. è¿è¡Œå®¹å™¨å¹¶æŒ‡å®šç½‘ç»œ
docker run -d \
  --name app1 \
  --network my_custom_network \
  --ip 172.20.0.10 \
  my_image

docker run -d \
  --name app2 \
  --network my_custom_network \
  --ip 172.20.0.11 \
  my_image

# 3. å®¹å™¨é—´å¯ä»¥ç›´æ¥ç”¨åç§°è®¿é—®
docker exec app1 ping app2  # âœ… å¯ä»¥pingé€š
docker exec app1 curl [http://app2:8080](http://app2:8080/)  # âœ… å¯ä»¥è®¿é—®
```

---

### ç¤ºä¾‹3ï¼šä½¿ç”¨docker-composeç®¡ç†ç½‘ç»œ

```yaml
# docker-compose.yml
version: '3.8'

services:
  gwagent:
    image: gwagent:latest
    container_name: gwagent
    networks:
      - default  # è‡ªåŠ¨åŠ å…¥ é¡¹ç›®å_default ç½‘ç»œ

  dify-api:
    image: dify-api:latest
    container_name: dify-api
    networks:
      - default
      - ssrf_proxy  # åŒæ—¶è¿æ¥ä¸¤ä¸ªç½‘ç»œ

  dify-db:
    image: postgres:15
    networks:
      - default

networks:
  default:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/16

  ssrf_proxy:
    driver: bridge
    ipam:
      config:
        - subnet: 172.19.0.0/16
```

**å¯åŠ¨åçš„æ•ˆæœï¼š**

```bash
docker-compose up -d

# gwagent å¯ä»¥ç›´æ¥è®¿é—® dify-api
docker exec gwagent curl [http://dify-api:5000](http://dify-api:5000/)

# dify-api æœ‰ä¸¤ä¸ªç½‘å¡
docker exec dify-api ip addr
# eth0: 172.18.0.x (defaultç½‘ç»œ)
# eth1: 172.19.0.x (ssrf_proxyç½‘ç»œ)
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆ `curl ``[localhost:5001](http://localhost:5001/)` è®¿é—®ä¸åˆ°å…¶ä»–å®¹å™¨ï¼Ÿ

**ç­”ï¼š** `[localhost](http://localhost/)` / `127.0.0.1` æ°¸è¿œæŒ‡å‘å®¹å™¨è‡ªå·±

```javascript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å®¹å™¨å†…éƒ¨                      â”‚
â”‚                                          â”‚
â”‚  127.0.0.1 â”€â”€â†’ åªèƒ½è®¿é—®æœ¬å®¹å™¨           â”‚
â”‚  172.18.0.8 â”€â”€â†’ è¿™æ‰æ˜¯å¯¹å¤–çš„IP          â”‚
â”‚                                          â”‚
â”‚  curl [http://localhost:5001](http://localhost:5001/)              â”‚
â”‚  â†’ è®¿é—®æœ¬å®¹å™¨çš„5001ç«¯å£                  â”‚
â”‚                                          â”‚
â”‚  curl [http://other-container:5001](http://other-container:5001/)        â”‚
â”‚  â†’ è®¿é—®å…¶ä»–å®¹å™¨ âœ…                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Q2: å®¹å™¨IPä¼šå˜å—ï¼Ÿ

**ç­”ï¼š** ä¼šï¼å®¹å™¨é‡å¯åIPå¯èƒ½æ”¹å˜

```bash
# ç¬¬ä¸€æ¬¡å¯åŠ¨
docker run --name app nginx
docker inspect app | grep IPAddress
# "IPAddress": "172.17.0.2"

# é‡å¯
docker restart app
docker inspect app | grep IPAddress
# "IPAddress": "172.17.0.2"  â† å¯èƒ½ä¸å˜

# ä½†å¦‚æœåˆ é™¤é‡å»º
docker rm -f app
docker run --name app nginx
docker inspect app | grep IPAddress
# "IPAddress": "172.17.0.5"  â† IPå˜äº†ï¼
```

**è§£å†³æ–¹æ¡ˆï¼š**

- âœ… ä½¿ç”¨å®¹å™¨å(Docker DNSè‡ªåŠ¨æ›´æ–°)

- âœ… ä½¿ç”¨docker-composeæŒ‡å®šå›ºå®šIP

- âŒ ä¸è¦åœ¨ä»£ç é‡Œå†™æ­»IP

---

### Q3: åŒä¸€ç½‘ç»œå¯ä»¥ç”¨IPè®¿é—®å—ï¼Ÿ

**ç­”ï¼š** å¯ä»¥,ä½†ä¸æ¨è

```bash
# âœ… å¯ä»¥ç”¨IP
curl [http://172.18.0.8:5001](http://172.18.0.8:5001/)

# âœ…âœ… æ›´æ¨èç”¨å®¹å™¨å
curl [http://dify-api:5001](http://dify-api:5001/)
```

**åŸå› ï¼š**

- å®¹å™¨åç¨³å®š,IPå¯èƒ½å˜

- å®¹å™¨åæ›´æ˜“è¯»

- Docker DNSè‡ªåŠ¨è§£æ

---

### Q4: å¦‚ä½•åˆ¤æ–­ä¸¤ä¸ªå®¹å™¨æ˜¯å¦åœ¨åŒä¸€ç½‘ç»œï¼Ÿ

```bash
# æ–¹æ³•1ï¼šæŸ¥çœ‹ç½‘ç»œæˆå‘˜
docker network inspect docker_default

# è¾“å‡ºï¼š
# "Containers": {
#     "abc123": {
#         "Name": "gwagent",
#         ...
#     },
#     "def456": {
#         "Name": "dify-api",
#         ...
#     }
# }

# æ–¹æ³•2ï¼šæŸ¥çœ‹å®¹å™¨çš„ç½‘ç»œ
docker inspect gwagent | grep -A 10 Networks
docker inspect dify-api | grep -A 10 Networks

# æ¯”è¾ƒè¾“å‡ºçš„ç½‘ç»œåç§°æ˜¯å¦ç›¸åŒ
```

---

### Q5: å®¹å™¨èƒ½è®¿é—®å®¿ä¸»æœºæœåŠ¡å—ï¼Ÿ

**ç­”ï¼š** å¯ä»¥,ä½¿ç”¨ç‰¹æ®Šçš„ä¸»æœºå

### Linux (Docker 20.10+)

```bash
# åœ¨å®¹å™¨å†…è®¿é—®å®¿ä¸»æœºçš„æœåŠ¡
curl [http://host.docker.internal:8080](http://host.docker.internal:8080/)

# æˆ–ä½¿ç”¨ç½‘å…³IP
curl [http://172.18.0.1:8080](http://172.18.0.1:8080/)  # 172.18.0.1 æ˜¯ç½‘æ¡¥çš„ç½‘å…³
```

### æŸ¥çœ‹ç½‘å…³IP

```bash
docker network inspect docker_default | grep Gateway
# "Gateway": "172.18.0.1"
```

---

## è¯Šæ–­å‘½ä»¤

### 1. æŸ¥çœ‹ç½‘ç»œåˆ—è¡¨

```bash
docker network ls

# è¾“å‡ºï¼š
# NETWORK ID       NAME              DRIVER
# abc123           bridge            bridge
# def456           docker_default    bridge
# ghi789           host              host
# jkl012           none              null
```

---

### 2. æŸ¥çœ‹ç½‘ç»œè¯¦æƒ…

```bash
docker network inspect docker_default

# é‡è¦ä¿¡æ¯ï¼š
# - Subnet: ç½‘æ®µ
# - Gateway: ç½‘å…³
# - Containers: è¿æ¥çš„å®¹å™¨åˆ—è¡¨
```

---

### 3. æŸ¥çœ‹å®¹å™¨çš„ç½‘ç»œé…ç½®

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨docker inspect
docker inspect å®¹å™¨å | grep -A 20 NetworkSettings

# æ–¹æ³•2ï¼šè¿›å…¥å®¹å™¨æŸ¥çœ‹
docker exec å®¹å™¨å ip addr
docker exec å®¹å™¨å ip route
docker exec å®¹å™¨å cat /etc/resolv.conf  # DNSé…ç½®
```

---

### 4. æŸ¥çœ‹å®¿ä¸»æœºçš„ç½‘æ¡¥å’Œveth

```bash
# æŸ¥çœ‹æ‰€æœ‰ç½‘æ¡¥
brctl show
# æˆ–
ip link show type bridge

# æŸ¥çœ‹ç½‘æ¡¥çš„è¯¦ç»†ä¿¡æ¯
ip addr show br-43ebdd777e58

# æŸ¥çœ‹æ‰€æœ‰veth pair
ip link show | grep veth
```

---

### 5. æµ‹è¯•å®¹å™¨é—´è¿é€šæ€§

```bash
# ä»å®¹å™¨A pingå®¹å™¨B
docker exec å®¹å™¨A ping å®¹å™¨B

# ä»å®¹å™¨A curlå®¹å™¨B
docker exec å®¹å™¨A curl [http://å®¹å™¨B:ç«¯å£](http://xn--b-y59a66n/:ç«¯å£)

# æŸ¥çœ‹å®¹å™¨çš„è·¯ç”±è¡¨
docker exec å®¹å™¨å ip route
```

---

### 6. æŸ¥çœ‹ç½‘ç»œæµé‡(æŠ“åŒ…)

```bash
# åœ¨ç½‘æ¡¥ä¸ŠæŠ“åŒ…
tcpdump -i br-43ebdd777e58 -nn

# åœ¨vethä¸ŠæŠ“åŒ…
tcpdump -i veth510a281 -nn

# è¿‡æ»¤ç‰¹å®šç«¯å£
tcpdump -i br-43ebdd777e58 port 5001 -nn
```

---

### 7. æŸ¥çœ‹iptablesè§„åˆ™

```bash
# æŸ¥çœ‹NATè§„åˆ™
iptables -t nat -L -n -v

# æŸ¥çœ‹FORWARDè§„åˆ™
iptables -L FORWARD -n -v

# æŸ¥çœ‹Dockerè‡ªåŠ¨æ·»åŠ çš„è§„åˆ™
iptables -t nat -L DOCKER -n
```

---

### 8. æ’æŸ¥ç½‘ç»œé—®é¢˜çš„å®Œæ•´æµç¨‹

```bash
# 1. ç¡®è®¤å®¹å™¨åœ¨å“ªä¸ªç½‘ç»œ
docker inspect å®¹å™¨å | grep -A 10 Networks

# 2. ç¡®è®¤ç½‘ç»œçš„ç½‘æ®µå’Œç½‘å…³
docker network inspect ç½‘ç»œå

# 3. åœ¨å®¹å™¨å†…æµ‹è¯•DNSè§£æ
docker exec å®¹å™¨å nslookup ç›®æ ‡å®¹å™¨å
docker exec å®¹å™¨å cat /etc/resolv.conf

# 4. æµ‹è¯•ç½‘ç»œè¿é€šæ€§
docker exec å®¹å™¨å ping ç›®æ ‡å®¹å™¨å
docker exec å®¹å™¨å curl [http://ç›®æ ‡å®¹å™¨å:ç«¯å£](http://xn--eqrr8cw6g8xo88r/:ç«¯å£)

# 5. æŸ¥çœ‹å®¹å™¨çš„ç½‘ç»œæ¥å£
docker exec å®¹å™¨å ip addr
docker exec å®¹å™¨å ip route

# 6. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
iptables -L -n | grep å®¹å™¨IP
```

---

## æœ€ä½³å®è·µ

### âœ… DO(æ¨è)

1. **ä½¿ç”¨è‡ªå®šä¹‰ç½‘ç»œ**

1. **ä½¿ç”¨å®¹å™¨åè®¿é—®**

1. **ä½¿ç”¨docker-composeç®¡ç†ç½‘ç»œ**

1. **åªæš´éœ²å¿…è¦çš„ç«¯å£**

---

### âŒ DON'T(é¿å…)

1. **ä¸è¦ä½¿ç”¨é»˜è®¤bridgeç½‘ç»œ**(å®¹å™¨æ— æ³•ç”¨åç§°äº’è®¿)

1. **ä¸è¦åœ¨ä»£ç é‡Œå†™æ­»IPåœ°å€**(IPä¼šå˜)

1. **ä¸è¦ä½¿ç”¨ ****`[localhost](http://localhost/)`**** è®¿é—®å…¶ä»–å®¹å™¨**

1. **ä¸è¦æš´éœ²ä¸å¿…è¦çš„ç«¯å£åˆ° ****`0.0.0.0`**

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æ¯ä¸ªå®¹å™¨éƒ½æœ‰ç‹¬ç«‹çš„ç½‘ç»œå‘½åç©ºé—´**

1. **veth pair è¿æ¥å®¹å™¨å’Œå®¿ä¸»æœº**

1. **ç½‘æ¡¥è´Ÿè´£è½¬å‘åŒä¸€ç½‘ç»œçš„æµé‡**

1. **åŒä¸€ç½‘ç»œçš„å®¹å™¨å¯ä»¥ç”¨å®¹å™¨åäº’è®¿**

1. **ä¸åŒç½‘ç»œçš„å®¹å™¨é»˜è®¤éš”ç¦»**

1. **`127.0.0.1`**** æ°¸è¿œåªè®¿é—®å®¹å™¨è‡ªå·±**

### é€šä¿¡æ–¹å¼å¯¹æ¯”

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´ï¼š** 2025-12-23

**é€‚ç”¨ç‰ˆæœ¬ï¼š** Docker 20.10+
